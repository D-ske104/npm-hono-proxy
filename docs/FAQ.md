## 🟢 概要・コンセプト

**Q. このツールは何のためにあるのですか？**
**A.** 「サプライチェーン攻撃」のリスクを減らすためです。npmで公開されたばかりの新しいバージョンには、悪意のあるコードが含まれている可能性があります。このツールは、公開から一定期間（デフォルト21日）経過していないバージョンを「存在しないもの」として扱い、誤ってインストールするのを防ぎます。

**Q. 「検疫 (Quarantine)」とはどういう状態ですか？**
**A.** そのバージョンが公開されてから、設定された安全期間（例: 21日間）が経過していない状態です。この期間中のバージョンは、セキュリティチェック待ちの状態とみなされ、`npm install` では取得できません。

**Q. すでに `package-lock.json` にあるバージョンもブロックされますか？**
**A.** いいえ、ブロックされません。`package-lock.json` に記録されているバージョン（＝すでにインストール実績があるもの）のダウンロード（Tarball取得）は、このツールをスルーして直接行われるため、既存のビルドが壊れることはありません。

## 🛠️ 利用・運用

**Q. `npm install` したら `ETARGET` エラーが出ました。なぜですか？**
**A.** インストールしようとしたパッケージのバージョンが「検疫中」である可能性が高いです。
`npm info <パッケージ名>` を実行して、`quarantine-latest` タグにそのバージョンが表示されていないか確認してください。もし表示されていれば、それはまだ安全とみなされていないため、プロキシによって隠蔽されています。

**Q. どうしても今すぐ最新版（検疫中のバージョン）を使いたいです。回避策は？**
**A.** 以下のいずれかの方法で回避できます。

1.  **一時的にレジストリ設定を戻す**: `npm install --registry https://registry.npmjs.org <パッケージ名>` のように、公式レジストリを直接指定してインストールしてください。
2.  **`package-lock.json` をコミットする**: 一度インストールして `package-lock.json` に記録されれば、以降はプロキシ経由でも（Tarballダウンロードはスルーされるため）インストール可能になります。

**Q. `latest` タグが古いバージョンを指しています。バグですか？**
**A.** 仕様です。本来の `latest` が検疫期間内である場合、安全に利用できる（期間を経過した）中で最も新しいバージョンに `latest` を付け替えています。
本来の最新版は `quarantine-latest` タグで確認できます。

**Q. `yarn` や `pnpm` でも使えますか？**
**A.** はい、使えます。どのパッケージマネージャーも標準的な npm レジストリ API を利用しているため、レジストリの URL をこのプロキシに向ければ同様に機能します。

**Q. プライベートレジストリ（Artifactoryなど）と併用できますか？**
**A.** スコープ付きパッケージ（`@mycorp/pkg` など）の設定で使い分けることが可能です。
`.npmrc` で以下のように設定してください：

```ini
registry=http://localhost:4873/  # 通常のパッケージはこのプロキシへ
@mycorp:registry=https://artifactory.example.com/ # 社内パッケージは直接向き先へ
```

※ このプロキシの `UPSTREAM` 設定自体をプライベートレジストリに向ける構成も可能です。

## 🚨 トラブルシューティング

**Q. `npm audit` で脆弱性が見つかったので `npm update` しましたが、更新されません。**
**A.** 修正版のバージョンが公開されたばかりの場合、そのバージョンも検疫対象になっている可能性があります。
緊急のセキュリティ対応が必要な場合は、前述の「レジストリ直接指定」でインストールを行ってください。

**Q. プロキシサーバーが落ちたらどうなりますか？**
**A.** `npm install` が失敗します。
開発業務が止まってしまう場合は、一時的に `.npmrc` の `registry` 設定を削除またはコメントアウトして、公式レジストリを直接使うように運用を切り替えてください。

**Q. ログに `redirect` が多いですが大丈夫ですか？**
**A.** 正常です。このツールはパッケージ情報（JSON）のみを検査し、実際のファイル（`.tgz`）のダウンロードリクエストは公式レジストリへリダイレクト（302）して転送負荷を下げています。

## 開発者向け（管理者向け）

**Q. 検疫期間を変更するには？**
**A.** 環境変数 `QUARANTINE_MINUTES` で分単位で指定できます。
例: `QUARANTINE_MINUTES=10080` (7日間)

**Q. ログを JSON 形式で出力したい（Datadogなどで集計したい）**
**A.** 環境変数 `LOG_FORMAT=ndjson` を設定してください。構造化ログが出力されます。
